<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <title>Health Dashboard</title>
  <style>
    body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; margin: 0; background: #f9f9f9; }
    header { background: #222; color: #fff; padding: 1rem 2rem; display: flex; justify-content: space-between; align-items: center; }
    header h1 { margin: 0; font-size: 1.3rem; }
    nav a { color: #fff; text-decoration: none; margin: 0 1rem; font-weight: 500; }
    nav a:hover { color: #4CAF50; }
    main { padding: 2rem; }
    h1, h2 { color: #333; }
    table { width: 100%; border-collapse: collapse; margin-top: 1rem; }
    th, td { padding: 10px; border: 1px solid #ccc; text-align: center; }
    th { background-color: #eee; }
    form { margin: 2rem 0; }
    input, select, button { padding: 8px; margin: 5px; }
    .alert-row { background-color: #ffe5e5; }
    button { cursor: pointer; }
    #content { display: none; }
  </style>
</head>
<body>

<script>
  const token = localStorage.getItem('token');
  if (!token) window.location.replace('login.html');
</script>

<div id="content">
  <header>
    <h1>ðŸ“Š Health Dashboard</h1>
    <nav>
      <a href="dashboard.html">Dashboard</a>
      <a href="about.html">About</a>
      <a href="feedback.html">Feedback</a>
      <a href="#" onclick="logout()">Logout</a>
    </nav>
  </header>

  <main>

    <!-- CONNECT BUTTONS -->
    <button id="connectFitbit">Connect Fitbit</button>
    <button id="connectWithings">Connect Withings</button>

    <!-- METRIC INPUT -->
    <form id="metricForm">
      <label>Type:
        <select name="metricType" required>
          <option value="temperature">Temperature</option>
          <option value="heart_rate">Heart Rate</option>
          <option value="blood_pressure_systolic">Blood Pressure Systolic</option>
          <option value="blood_pressure_diastolic">Blood Pressure Diastolic</option>
          <option value="blood_sugar">Blood Sugar</option>
        </select>
      </label>
      <label>Value:
        <input type="number" step="0.1" name="value" required />
      </label>
      <button type="submit">âž• Submit Metric</button>
    </form>

    <!-- METRICS TABLE -->
    <h2>Metrics</h2>
    <table id="metricsTable">
      <thead>
        <tr>
          <th>Type</th>
          <th>Value</th>
          <th>Alert</th>
          <th>Recorded At</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>

    <!-- HEART RATE CHART -->
    <h2>ðŸ“ˆ Heart Rate Trend</h2>
    <canvas id="heartRateChart" width="400" height="200"></canvas>

    <!-- ALERT HISTORY -->
    <h2>ðŸš¨ Alert History</h2>
    <table id="alertsTable">
      <thead>
        <tr>
          <th>Type</th>
          <th>Value</th>
          <th>Reason</th>
          <th>Created At</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
    <canvas id="alertsChart" width="400" height="200"></canvas>

    <!-- â­ NEW: SYMPTOMS SECTION -->
    <h2>ðŸ©º Symptom Tracking</h2>

    <!-- Add Symptom Form -->
    <form id="symptomForm">
      <label>Symptom:
        <select name="symptom" required>
          <option value="headache">Headache</option>
          <option value="fatigue">Fatigue</option>
          <option value="nausea">Nausea</option>
          <option value="dizziness">Dizziness</option>
          <option value="shortness_of_breath">Shortness of Breath</option>
          <option value="chest_pain">Chest Pain</option>
        </select>
      </label>

      <label>Severity:
        <select name="severity" required>
          <option value="1">1 â€“ Mild</option>
          <option value="2">2</option>
          <option value="3">3 â€“ Moderate</option>
          <option value="4">4</option>
          <option value="5">5 â€“ Severe</option>
        </select>
      </label>

      <label>Notes:
        <input type="text" name="notes" placeholder="Optional notes..." />
      </label>

      <button type="submit">âž• Add Symptom</button>
    </form>

    <!-- Symptoms Table -->
    <h2>Symptoms History</h2>
    <table id="symptomsTable">
      <thead>
        <tr>
          <th>Symptom</th>
          <th>Severity</th>
          <th>Notes</th>
          <th>Recorded At</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>

  </main>
</div>

<script>
document.addEventListener("DOMContentLoaded", () => {

  document.getElementById('content').style.display = 'block';

  window.logout = function() {
    localStorage.removeItem('token');
    window.location.replace('login.html');
  };

  // --------------------------
  // METRICS
  // --------------------------
  async function fetchMetrics() {
    const res = await fetch('/api/metrics', { headers: { Authorization: 'Bearer ' + token }});
    const metrics = await res.json();
    const tbody = document.querySelector('#metricsTable tbody');
    tbody.innerHTML = '';

    metrics.forEach(metric => {
      const row = document.createElement('tr');
      if (metric.alert) row.classList.add('alert-row');
      row.innerHTML = `
        <td>${metric.metric_type}</td>
        <td>${metric.value}</td>
        <td>${metric.alert ?? ''}</td>
        <td>${metric.recorded_at ? new Date(metric.recorded_at).toLocaleString() : 'N/A'}</td>
      `;
      tbody.appendChild(row);
    });
  }

  // --------------------------
  // HEART RATE CHART
  // --------------------------
  let heartRateChart;
  async function drawHeartRateChart() {
    const res = await fetch('/api/metrics', { headers: { Authorization: 'Bearer ' + token }});
    const metrics = await res.json();

    const heartRates = metrics.filter(m => m.metric_type === 'heart_rate')
      .sort((a,b)=> new Date(a.recorded_at) - new Date(b.recorded_at));

    const labels = heartRates.map(m => new Date(m.recorded_at).toLocaleString());
    const values = heartRates.map(m => Number(m.value));

    const ctx = document.getElementById('heartRateChart').getContext('2d');
    if (heartRateChart) heartRateChart.destroy();

    heartRateChart = new Chart(ctx, {
      type: 'line',
      data: { labels, datasets: [{ label: 'Heart Rate', data: values, borderColor: 'red', fill: false }] },
    });
  }

  // --------------------------
  // ALERT HISTORY
  // --------------------------
  let alertsChart;
  async function fetchAlerts() {
    const res = await fetch('/api/alerts', { headers: { Authorization: 'Bearer ' + token }});
    const alerts = await res.json();

    const tbody = document.querySelector('#alertsTable tbody');
    tbody.innerHTML = '';

    alerts.forEach(alert => {
      const row = document.createElement('tr');
      row.innerHTML = `
        <td>${alert.metric_type}</td>
        <td>${alert.value}</td>
        <td>${alert.reason}</td>
        <td>${new Date(alert.created_at).toLocaleString()}</td>
      `;
      tbody.appendChild(row);
    });
  }

  // --------------------------
  // NEW: SYMPTOMS
  // --------------------------
  async function fetchSymptoms() {
    const res = await fetch('/api/symptoms', { headers: { Authorization: 'Bearer ' + token }});
    const symptoms = await res.json();

    const tbody = document.querySelector('#symptomsTable tbody');
    tbody.innerHTML = '';

    symptoms.forEach(s => {
      const row = document.createElement('tr');
      row.innerHTML = `
        <td>${s.symptom}</td>
        <td>${s.severity}</td>
        <td>${s.notes || ''}</td>
        <td>${new Date(s.recorded_at).toLocaleString()}</td>
      `;
      tbody.appendChild(row);
    });
  }

  // SYMPTOM FORM SUBMIT
  document.getElementById('symptomForm').addEventListener('submit', async (e) => {
    e.preventDefault();

    const data = {
      symptom: e.target.symptom.value,
      severity: Number(e.target.severity.value),
      notes: e.target.notes.value
    };

    const res = await fetch('/api/symptoms', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        Authorization: 'Bearer ' + token
      },
      body: JSON.stringify(data)
    });

    if (res.ok) {
      e.target.reset();
      fetchSymptoms();
    } else {
      alert("Failed to add symptom");
    }
  });

  // Initialize everything
  fetchMetrics().then(drawHeartRateChart);
  fetchAlerts();
  fetchSymptoms();

});
</script>

</body>
</html>